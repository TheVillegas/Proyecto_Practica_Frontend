<!-- Card Container matches HTML prototype structure -->
<div class="ali-card">

  <!-- Header / Summary Section -->
  <div class="card-header" (click)="toggleExpand()">
    <div class="header-left">
      <!-- Icon Container -->
      <div class="icon-container"
        [ngClass]="isExpanded ? 'bg-brand-primary text-white shadow-md' : 'bg-blue-50 text-brand-primary group-hover:bg-brand-primary group-hover:text-white'">
        <ion-icon name="flask-outline" class="text-2xl"></ion-icon>
      </div>

      <!-- Title Section -->
      <div class="title-section">
        <span class="label-id" [ngClass]="isExpanded ? 'text-brand-primary/70' : 'text-gray-400'">
          ID de Muestra
        </span>
        <h3 class="value-id" [ngClass]="isExpanded ? 'text-brand-primary' : 'text-gray-900'">
          {{muestra.ALIMuestra}}
        </h3>
      </div>
    </div>

    <!-- Actions (Right Side) -->
    <div class="actions-right">
      <!-- Excel Button -->
      <!-- Note: Using click stopPropagation to prevent toggling expansion when clicking button -->
      <button class="btn-excel" title="Generar reporte Excel" (click)="$event.stopPropagation()">
        <ion-icon name="document-text-outline" class="excel-icon"></ion-icon>
        <span class="hidden sm:inline">Generar Excel</span>
      </button>

      <div class="btn-separator"></div>

      <!-- Delete Button -->
      <button class="btn-delete" title="Eliminar ALI" (click)="eliminarALI($event)">
        <ion-icon name="trash-outline" class="delete-icon"></ion-icon>
      </button>

      <!-- Expand/Collapse Button -->
      <button class="btn-expand"
        [ngClass]="isExpanded ? 'text-brand-primary bg-brand-primary/10' : 'text-gray-400 hover:text-brand-primary'"
        title="Ver detalles">
        <ion-icon [name]="isExpanded ? 'chevron-up-outline' : 'chevron-down-outline'" class="expand-icon"></ion-icon>
      </button>
    </div>
  </div>

  <!-- Expanded Details Section -->
  <div *ngIf="isExpanded" class="expanded-section">
    <div class="details-grid">
      <div class="grid-col">
        <div class="details-wrapper">
          <div class="observations-wrapper">
            <!-- Observaciones Cliente (Read Only) -->
            <div>
              <h4 class="section-title">Observaciones Cliente</h4>
              <div class="obs-readonly">
                {{muestra.observacionesCliente || 'Sin observaciones.'}}
              </div>
            </div>

            <!-- Observaciones Generales (Editable) -->
            <div>
              <h4 class="section-title">Observaciones Generales</h4>
              <textarea [(ngModel)]="muestra.observacionesGenerales" class="obs-textarea"
                placeholder="Escriba aquí las observaciones generales..."></textarea>
              <div class="boton-añadir-imagen">
                <button class="btn-add-imagen" (click)="adjuntarImagen()">Adjuntar Imagen</button>
              </div>

              <!-- Lista de imágenes adjuntadas -->
              <div *ngIf="muestra.imagenesObservaciones && muestra.imagenesObservaciones.length > 0"
                class="imagenes-adjuntadas">
                <h5 class="imagenes-title">Imágenes Adjuntadas:</h5>
                <div class="imagen-item" *ngFor="let imagen of muestra.imagenesObservaciones; let i = index">
                  <div class="imagen-preview">
                    <img [src]="imagen.data" [alt]="imagen.nombre" class="thumbnail">
                  </div>
                  <div class="imagen-info">
                    <span class="imagen-nombre" [title]="imagen.nombre">{{ imagen.nombre }}</span>
                    <span class="imagen-metadata">{{ formatearTamanio(imagen.tamanio) }} • {{
                      formatearFecha(imagen.fechaAdjunto) }}</span>
                  </div>
                  <button class="btn-eliminar-imagen" (click)="eliminarImagen(i)" title="Eliminar imagen">
                    <ion-icon name="trash-outline"></ion-icon>
                  </button>
                </div>
              </div>

              <div class="btn-save-container">
                <button (click)="guardarObservaciones()" class="btn-save">
                  Guardar
                </button>
              </div>
            </div>
          </div>
          <h4 class="doc-section-title">Documentación Asociada</h4>
          <!-- Reporte TPA -->
          <div class="doc-card" [ngClass]="getContainerStyle(muestra.reporteTPA.estado)">
            <div class="doc-icon-wrapper">
              <ion-icon
                [name]="muestra.reporteTPA.estado === 'Verificado' ? 'checkmark-circle-outline' : 'document-outline'"
                class="doc-icon"
                [ngClass]="muestra.reporteTPA.estado === 'Verificado' ? 'text-brand-primary' : 'text-gray-400'">
              </ion-icon>
              <div class="doc-info">
                <span class="doc-label"
                  [ngClass]="muestra.reporteTPA.estado === 'Verificado' ? 'text-gray-900' : 'text-gray-700'">
                  Reporte TPA
                </span>
                <a class="doc-link" (click)="goToReporteTPA($event)">
                  Ver documento
                </a>
              </div>
            </div>
            <span class="status-badge-custom" [ngClass]="getColorEstado(muestra.reporteTPA.estado)">
              {{ muestra.reporteTPA.estado || 'PENDIENTE' }}
            </span>
          </div>

          <!-- Reporte RAM -->
          <div class="doc-card" [ngClass]="getContainerStyle(muestra.reporteRAM.estado)">
            <div class="doc-icon-wrapper">
              <ion-icon
                [name]="muestra.reporteRAM.estado === 'Verificado' ? 'checkmark-circle-outline' : 'document-outline'"
                class="doc-icon"
                [ngClass]="muestra.reporteRAM.estado === 'Verificado' ? 'text-brand-primary' : 'text-gray-400'">
              </ion-icon>
              <div class="doc-info">
                <span class="doc-label"
                  [ngClass]="muestra.reporteRAM.estado === 'Verificado' ? 'text-gray-900' : 'text-gray-700'">
                  Reporte RAM
                </span>
                <a class="doc-link" (click)="goToReporteRAM($event)">
                  Ver documento
                </a>
              </div>
            </div>
            <span class="status-badge-custom" [ngClass]="getColorEstado(muestra.reporteRAM.estado)">
              {{ muestra.reporteRAM.estado || 'PENDIENTE' }}
            </span>
          </div>

        </div>
      </div>
    </div>
  </div>

</div>